# Обучение OpenCV каскада Хаара

[Пост на Хабре](https://habrahabr.ru/post/208092/)


###### Использованные базы изображений:
- [The Caltech Database](http://www.vision.caltech.edu/html-files/archive.html)
- [Vehicle Image Database](https://www.gti.ssr.upm.es/data/Vehicle_database.html)


### Подготовка даных

Структура папок:
```
|-Good
   |-image0000.png
   |-image0001.png
   |-....
   |-image0974.png
|-Bad
   |-image0000.png
   |-image0001.png
   |-....
   |-image0974.png
Good.dat
Bad.dat
```

Для файла отрицательных примеров это просто список относительных путей к изображениям:
```
Bad/image0000.png
Bad/image0001.png
Bad/.....png
Bad/image0974.png
```

Для файлов с положительными примерами запись чуть хитрее. Кроме пути должно быть указанно положение рассматриваемого объекта и его размер. В принципе, каждое положительное изображение может содержать несколько примеров объектов. Но лучше всего: один кадр — один объект.
```
Good/image0000.png  1  0 0 64 64
Good/image0001.png  1  0 0 64 64
Good/.....png       1  0 0 64 64
Good/image0974.png  1  0 0 64 64
```


## Обучение. Часть I (все положительные изображения приводятся к общему формату)

opencv-3.2.0/build/bin/opencv_createsamples

```
sudo ~/Development/"Untitled Folder"/opencv-3.2.0/build/bin/opencv_createsamples -info ~/Development/PycharmProjects/analyze-x/data/my_collection/Good.dat -vec samples.vec -w 20 -h 20
```

`-info ~/Development/PycharmProjects/analyze-x/data/my_collection/Good.dat` – файл описания положительных изображений. Указывается либо полный адрес, либо относительно программы `opencv_createsamples`.
 
`-vec samples.vec` – файл, в который будет сохранена приведённая к общему формату база положительных изображений. Адрес должен быть указан относительно программы opencv_createsamples (допустим полный путь в системе).

`-w 20 -h 20` — размер шаблона. Должен приблизительно отражать пропорции искомого объекта. Размер шаблона должен быть достаточно маленьким. Идеально ставить его таким, чтобы человек сам мог отличить изображённый объект, но не больше того. Чем больше шаблон, тем дольше обучение.


## Обучение. Часть II (создаём итоговый каскад)

```
$ sudo ~/Development/Untitled\ Folder/opencv-3.2.0/build/bin/opencv_traincascade \
> -data haarcascade -vec samples.vec \
> -bg ~/Development/PycharmProjects/analyze-x/data/my_collection/Bad.dat \  
> -numStages 16 -minhitrate 0.999 -maxFalseAlarmRate 0.4 -numPos 200 -numNeg 975 -w 20 -h 20 -mode ALL -precalcValBufSize 1024 -precalcIdxBufSize 1024

```

`-data haarcascade` — адрес папки, куда класть полученные результаты. Отсчитывается от корневой папки программы. Нужно создать заранее, а то всё вылетит.

`-vec samples.vec` — адрес посчитанного в прошлом пункте файла с положительными примерами.

`-bg ~/Development/PycharmProjects/analyze-x/data/my_collection/Bad.dat` — адрес файла-описания отрицательных примеров.

`-numStages 16` — количество уровней каскада, которые программа будет обучать. Чем больше уровней, тем точнее, но тем дольше. Нормальное их количество от 16 до 25.

`-minhitrate 0.999` — коэффициент, определяющий качество обучения. По сути, это процент "правильных" обнаружений. Если установлено .999, то есть по исходной выборке будет не более, чем 1- 0.999 =0.1% пропусков целей. Чем выше коэффициент, тем выше уровень ложных тревог. В принципе, если выборка хорошая, можно ставить 0.99-0.999. Если плохая (объектов мало, они смешиваются с фоном) — то следует опускать.

`-maxFalseAlarmRate 0.4` — уровень ложной тревоги. AdaBoost — такой алгоритм, который может любой уровень ложной тревоги по выборке натянуть. Но лучше что-то разумное сделать. По умолчанию все ставят 0.5. Но, возможно, будет иметь смысл поиграться. В случае, если выборка очень хорошая, то уровень требуемой тревоги будет быстро достигнут, и обучение будет остановлено.

`-numPos 200` — количество позитивных примеров. **ВАЖНО!** Казалось бы, тут должно стоять число файлов, которые у вас были. Но это не так (в большинстве руководств это не отмечено). Чем ниже коэффициент `minhitrate`, тем больше ваших файлов будет считаться непригодными. В большинстве случаев достаточно поставить numPos 80% от имеющихся у вас положительных файлов. Лучше перестраховаться, чтобы через день работы программа не вылетела с ошибкой:)

`-numNeg 500` — количество имеющихся у вас негативных примеров. Что есть — то и пишем.

`-w 20 -h 20` — размер примитива из прошлого пункта.

`-mode ALL` — использовать или нет полный комплект Хаар-признаков. От этого зависит скорость работы и точность алгоритма. Но есть ситуации, когда полного комплекта признаков не нужно (например, если ваш объект не меняет ориентацию).

`-precalcValBufSize 1024 -precalcIdxBufSize 1024` — выделяемая под процесс память.
